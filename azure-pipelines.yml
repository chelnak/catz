trigger:
  batch: true
  branches:
    include:
      - "*"
  tags:
    include:
      - "v*"      
  paths:
    include:
      - jcat/*
      - azure-pipelines.yml
      - requirements.txt

pr: none

pool:
  vmImage: 'ubuntu-18.04'

stages:
  - stage: CI
    jobs: 
    - job: Build
      steps:
        - task: UseGitVersion@5
          inputs:
            versionSpec: 5.x
            useConfigFile: true
            configFilePath: GitVersion.yml

        - task: UsePythonVersion@0
          inputs:
            versionSpec: 3.8.3

        - pwsh: $(System.DefaultWorkingDirectory)/scripts/build.ps1

        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: $(System.DefaultWorkingDirectory)/artifacts
            artifactName: publish

    - job: BuildForPlatform
      strategy:
        matrix:
          linux:
            imageName: 'ubuntu-18.04'
          windows:
            imageName: 'windows-latest'
      pool:
        vmImage: $(imageName)
      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: 3.8.3

        - pwsh: $(System.DefaultWorkingDirectory)/scripts/build.ps1 -BuildForPlatform

        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: $(System.DefaultWorkingDirectory)/artifacts
            artifactName: publish

  - stage: Release
    dependsOn: CI
    condition: succeeded('CI')
    jobs:
    - job: release
      condition: startswith(variables['Build.SourceBranch'], 'refs/tags/v')
      steps:      
        - task: DownloadPipelineArtifact@2
          displayName: Restore Pipeline Artifacts

        - script: 'pip install twine'
        - task: TwineAuthenticate@0
          inputs:
            externalFeeds: 'pypi-jcat'
        - script: 'twine upload -r {pypi-jcat/jcat} --config-file $(PYPIRC_PATH) "$(Pipeline.Workspace)/publish/*"'

        - task: GitHubRelease@1
          displayName: Create a GitHub GitHubRelease
          condition: 
          inputs:
            gitHubConnection: 'chelnak'
            title: jcat
            repositoryName: 'chelnak/jcat'
            assets: "$(Pipeline.Workspace)/publish/*.*"
